<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>迷宮之下 — 互動敘事地圖</title>
<style>
:root {
  --bg: #1a1a2e;
  --bg2: #16213e;
  --bg3: #0f3460;
  --text: #e0e0e0;
  --text2: #a0a0b0;
  --accent: #e94560;
  --accent2: #533483;
  --border: #2a2a4a;
  --card: #1e1e3a;
  --tag-char: #4a9;
  --tag-cond: #a74;
  --chapter-bg: linear-gradient(135deg, var(--accent2), var(--bg3));
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  height: 100vh;
  overflow: hidden;
}
/* Layout */
.app { display: flex; height: 100vh; }
.sidebar {
  width: 300px;
  min-width: 280px;
  background: var(--bg2);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  padding: 16px;
  flex-shrink: 0;
}
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.toolbar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  scroll-behavior: smooth;
}

/* Sidebar */
.sidebar h2 {
  font-size: 14px;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin: 16px 0 8px 0;
  border-bottom: 1px solid var(--border);
  padding-bottom: 4px;
}
.sidebar h2:first-child { margin-top: 0; }
.toggle-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
  font-size: 13px;
  color: var(--text2);
  cursor: pointer;
}
.toggle-row input { accent-color: var(--accent); cursor: pointer; }
.toggle-row:hover { color: var(--text); }

/* Character filter */
.char-list { display: flex; flex-wrap: wrap; gap: 4px; margin: 4px 0; }
.char-btn {
  padding: 3px 8px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}
.char-btn:hover { border-color: var(--tag-char); color: var(--tag-char); }
.char-btn.active {
  background: var(--tag-char);
  color: #fff;
  border-color: var(--tag-char);
}

/* Toolbar */
.toolbar .stats {
  font-size: 13px;
  color: var(--text2);
}
.toolbar .stats b { color: var(--accent); }
.search-box {
  padding: 4px 10px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text);
  font-size: 13px;
  width: 250px;
}
.search-box:focus { outline: none; border-color: var(--accent); }
.view-toggle {
  margin-left: auto;
  display: flex;
  gap: 4px;
}
.view-btn {
  padding: 4px 12px;
  border-radius: 4px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-size: 12px;
  cursor: pointer;
}
.view-btn.active { background: var(--accent2); color: #fff; border-color: var(--accent2); }

/* Chapter header (narrative view) */
.chapter-header {
  width: 100%;
  background: var(--chapter-bg);
  padding: 16px 20px;
  margin: 24px 0 8px 0;
  border-radius: 10px;
  position: sticky;
  top: 0;
  z-index: 10;
  cursor: pointer;
  user-select: none;
}
.chapter-header:first-child { margin-top: 0; }
.chapter-header h2 {
  font-size: 20px;
  color: #fff;
  margin: 0 0 4px 0;
  border: none;
  padding: 0;
  text-transform: none;
  letter-spacing: 0;
}
.chapter-header .chapter-desc {
  font-size: 13px;
  color: rgba(255,255,255,0.7);
  margin-bottom: 4px;
}
.chapter-header .chapter-stats {
  font-size: 12px;
  color: rgba(255,255,255,0.5);
}
.chapter-header .chapter-stats b { color: var(--accent); }
.chapter-body { display: none; }
.chapter-body.open { display: block; }

/* Sub-group header (narrative view) */
.sub-group-header {
  background: rgba(15, 52, 96, 0.6);
  padding: 10px 14px;
  margin: 12px 0 6px 0;
  border-radius: 6px;
  border-left: 3px solid var(--tag-char);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  user-select: none;
}
.sub-group-header h4 {
  font-size: 14px;
  color: var(--text);
  flex: 1;
}
.sub-group-header .meta {
  font-size: 11px;
  color: var(--text2);
}
.sub-group-header .scene-portrait {
  width: 36px; height: 36px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--tag-char);
  flex-shrink: 0;
}
.sub-group-body { display: none; padding-left: 8px; }
.sub-group-body.open { display: block; }

/* Condition separator (narrative view) */
.cond-separator {
  border-top: 1px dashed var(--border);
  margin: 8px 0 4px 0;
  padding-top: 4px;
}
.cond-separator .cond-group-label {
  font-size: 11px;
  color: var(--tag-cond);
  font-family: monospace;
  margin-bottom: 4px;
}

/* Content cards (scene / character views) */
.scene-header {
  background: var(--bg3);
  padding: 12px 16px;
  margin: 16px 0 8px 0;
  border-radius: 8px;
  border-left: 4px solid var(--accent);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 12px;
  user-select: none;
}
.scene-header-text { flex: 1; min-width: 0; }
.scene-portrait {
  width: 48px; height: 48px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--accent);
  flex-shrink: 0;
}
.scene-header h3 { font-size: 16px; margin-bottom: 2px; }
.scene-header .meta { font-size: 12px; color: var(--text2); }
.scene-header .char-tags { display: inline; }
.scene-header .char-tag {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 8px;
  background: var(--tag-char);
  color: #fff;
  font-size: 11px;
  margin-left: 4px;
}
.scene-header .cat-tag {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 8px;
  background: var(--accent2);
  color: #fff;
  font-size: 11px;
}

.passage {
  background: var(--card);
  padding: 12px 16px;
  margin: 4px 0;
  border-radius: 6px;
  border-left: 3px solid transparent;
  transition: border-color 0.2s;
}
.passage:hover { border-left-color: var(--accent); }
.passage .cond-tags {
  margin-bottom: 6px;
}
.passage .cond-tag {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 4px;
  background: rgba(170, 119, 68, 0.2);
  color: var(--tag-cond);
  font-size: 11px;
  margin-right: 4px;
  font-family: monospace;
}
.passage .pid {
  font-size: 11px;
  color: var(--text2);
  float: right;
}
.passage .text { font-size: 14px; line-height: 1.8; }
/* Loading */
.loading {
  text-align: center;
  padding: 60px;
  color: var(--text2);
  font-size: 18px;
}
.loading .spinner {
  display: inline-block;
  width: 40px; height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Virtual scroll sentinel */
.sentinel { height: 1px; }

/* Responsive */
@media (max-width: 768px) {
  .app { flex-direction: column; }
  .sidebar {
    width: 100%;
    max-height: 40vh;
    border-right: none;
    border-bottom: 1px solid var(--border);
  }
}

/* Title */
.app-title {
  font-size: 16px;
  font-weight: bold;
  color: var(--accent);
  margin-bottom: 8px;
  text-align: center;
}
.app-subtitle {
  font-size: 11px;
  color: var(--text2);
  text-align: center;
  margin-bottom: 12px;
}

/* Scene collapse */
.scene-passages { display: none; }
.scene-passages.open { display: block; }

/* Show all variants toggle */
.show-all-toggle {
  font-size: 12px;
  color: var(--accent);
  cursor: pointer;
  padding: 4px 0;
  text-align: center;
}
.show-all-toggle:hover { text-decoration: underline; }

/* Passage sprite images */
.passage-with-img {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}
.passage-img {
  flex-shrink: 0;
  width: 120px;
  height: auto;
  border-radius: 6px;
  border: 1px solid var(--border);
  cursor: pointer;
  transition: transform 0.2s;
}
.passage-img:hover {
  transform: scale(1.05);
}
.passage-text-col {
  flex: 1;
  min-width: 0;
}

/* Multi-character portraits row */
.passage-portraits {
  display: flex;
  gap: 6px;
  margin-bottom: 6px;
}
.passage-portraits img {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid var(--border);
  object-fit: cover;
}

/* Lightbox */
.lightbox-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  cursor: pointer;
}
.lightbox-overlay.active { display: flex; }
.lightbox-overlay img {
  max-width: 90vw;
  max-height: 90vh;
  border-radius: 8px;
  box-shadow: 0 0 40px rgba(0,0,0,0.5);
}

/* Scrollbar */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent2); }

/* Mobile responsive */
@media (max-width: 768px) {
  .passage-with-img {
    flex-direction: column;
    gap: 8px;
  }
  .passage-img {
    width: 100%;
    max-width: 200px;
  }
  .passage .text { font-size: 15px; line-height: 1.9; }
  .toolbar { padding: 6px 10px; gap: 6px; }
  .search-box { width: 100%; }
  .view-toggle { margin-left: 0; width: 100%; justify-content: center; }
  .chapter-header h2 { font-size: 17px; }
  .sub-group-header h4 { font-size: 13px; }
  .sidebar { padding: 10px; }
  .sidebar h2 { font-size: 12px; }
}
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar: State Controls -->
  <div class="sidebar" id="sidebar">
    <div class="app-title">迷宮之下</div>
    <div class="app-subtitle">Underneath the Labyrinth — 互動敘事地圖</div>

    <h2>角色篩選</h2>
    <div class="char-list" id="charFilter">
      <button class="char-btn active" data-char="all">全部</button>
    </div>

    <h2>顯示模式</h2>
    <div class="toggle-row">
      <input type="checkbox" id="showAllVariants">
      <label for="showAllVariants">展開所有變體</label>
    </div>
    <div class="toggle-row">
      <input type="checkbox" id="showEnglish">
      <label for="showEnglish">顯示英文原文預覽</label>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="toolbar">
      <input type="text" class="search-box" id="searchBox" placeholder="搜尋文本 / 角色 / 場景...">
      <div class="stats" id="stats"></div>
      <div class="view-toggle">
        <button class="view-btn active" data-view="narrative" id="viewNarrative">按敘事</button>
        <button class="view-btn" data-view="scene" id="viewScene">按場景</button>
        <button class="view-btn" data-view="character" id="viewChar">按角色</button>
      </div>
    </div>
    <div class="content" id="content">
      <div class="loading">
        <div class="spinner"></div>
        <div>載入敘事數據中...</div>
      </div>
    </div>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox-overlay" id="lightbox">
  <img src="" alt="放大圖片" id="lightboxImg">
</div>

<script>
// === Global State ===
let DATA = null;
let SPRITES = null;
let activeChar = 'all';
let searchQuery = '';
let showAllVariants = false;
let showEnglish = false;
let currentView = 'narrative';
let renderedScenes = 0;
const BATCH_SIZE = 15;

// === Lightbox ===
function openLightbox(src) {
  const overlay = document.getElementById('lightbox');
  document.getElementById('lightboxImg').src = src;
  overlay.classList.add('active');
}
document.getElementById('lightbox').addEventListener('click', function() {
  this.classList.remove('active');
});

// === Data Loading ===
async function loadData() {
  const [passResp, spriteResp] = await Promise.all([
    fetch('data/passages.json'),
    fetch('data/sprite_map.json').catch(() => null),
  ]);
  DATA = await passResp.json();
  if (spriteResp && spriteResp.ok) SPRITES = await spriteResp.json();
  init();
}

// === Rendering ===

function buildCharFilter() {
  const container = document.getElementById('charFilter');
  let html = '<button class="char-btn active" data-char="all">全部</button>';
  DATA.characters.forEach(ch => {
    const count = DATA.passages.filter(p => p.characters.includes(ch)).length;
    const display = CHAR_DISPLAY[ch] || ch;
    html += `<button class="char-btn" data-char="${ch}">${display} (${count})</button>`;
  });
  container.innerHTML = html;
  container.querySelectorAll('.char-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      container.querySelectorAll('.char-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      activeChar = e.target.dataset.char;
      resetAndRender();
    });
  });
}

function getFilteredPassages() {
  let passages = DATA.passages;
  // Character filter
  if (activeChar !== 'all') {
    passages = passages.filter(p => p.characters.includes(activeChar));
  }
  // Search
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    passages = passages.filter(p =>
      (p.text_zh || '').toLowerCase().includes(q) ||
      (p.es_name || '').toLowerCase().includes(q) ||
      (p.branch_label || '').toLowerCase().includes(q) ||
      p.characters.some(c => c.toLowerCase().includes(q))
    );
  }
  return passages;
}

// === Grouping functions ===

function groupByScene(passages) {
  const groups = new Map();
  passages.forEach(p => {
    const key = p.es_idx;
    if (!groups.has(key)) {
      groups.set(key, {
        es_idx: p.es_idx,
        es_name: p.es_name,
        characters: [],
        category: p.category,
        passages: [],
      });
    }
    const group = groups.get(key);
    group.passages.push(p);
    p.characters.forEach(ch => {
      if (!group.characters.includes(ch)) group.characters.push(ch);
    });
  });
  return Array.from(groups.values());
}

function groupByCharacter(passages) {
  const groups = new Map();
  passages.forEach(p => {
    const chars = p.characters.length > 0 ? p.characters : ['_untagged'];
    chars.forEach(ch => {
      if (!groups.has(ch)) {
        groups.set(ch, {
          es_idx: 0,
          es_name: ch === '_untagged' ? '未標記角色' : (CHAR_DISPLAY[ch] || ch),
          characters: ch === '_untagged' ? [] : [ch],
          category: 'Character',
          passages: [],
        });
      }
      groups.get(ch).passages.push(p);
    });
  });
  const sorted = Array.from(groups.values()).sort((a, b) => {
    if (a.es_name === '未標記角色') return 1;
    if (b.es_name === '未標記角色') return -1;
    return a.es_name.localeCompare(b.es_name);
  });
  return sorted;
}

function groupByNarrative(passages) {
  // Build: branch_type → es_idx (quest) → passages
  const sections = new Map();
  passages.forEach(p => {
    const bt = p.branch_type || 'Other';
    if (!sections.has(bt)) sections.set(bt, new Map());
    const quests = sections.get(bt);
    const esKey = p.es_idx != null ? p.es_idx : 'none';
    if (!quests.has(esKey)) {
      quests.set(esKey, {
        es_idx: p.es_idx,
        es_name: p.es_name || '(independent)',
        characters: [],
        passages: [],
      });
    }
    const quest = quests.get(esKey);
    quest.passages.push(p);
    (p.characters || []).forEach(ch => {
      if (!quest.characters.includes(ch)) quest.characters.push(ch);
    });
  });

  // Convert to ordered array using branch_types metadata
  const btMeta = DATA.branch_types || [];
  const btOrder = btMeta.map(b => b.id);

  const result = [];
  // First add in defined order
  btOrder.forEach(bt => {
    if (sections.has(bt)) {
      const meta = btMeta.find(b => b.id === bt) || { label: bt };
      const quests = Array.from(sections.get(bt).values());
      result.push({
        id: bt,
        label: meta.label,
        quest_count: meta.quest_count || quests.length,
        quests: quests,
      });
      sections.delete(bt);
    }
  });
  // Then any remaining
  for (const [bt, questMap] of sections.entries()) {
    const quests = Array.from(questMap.values());
    result.push({
      id: bt,
      label: bt,
      quest_count: quests.length,
      quests: quests,
    });
  }
  return result;
}

// === Portrait helpers ===

// Sprite alias: map new character keys to sprite_map keys
const CHAR_SPRITE_ALIAS = {
  'GreyMale': 'Grey', 'GreyFemale': 'Grey', 'Altrius': 'FemaleAgent',
};
// Display names for character filter buttons
const CHAR_DISPLAY = {
  'GreyMale': 'Grey♂', 'GreyFemale': 'Grey♀', 'Altrius': 'Altrius',
};

function getCharPortrait(charName) {
  if (!SPRITES) return '';
  const mapped = CHAR_SPRITE_ALIAS[charName] || charName;
  const key = mapped.toLowerCase();
  if (SPRITES.portraits && SPRITES.portraits[key]) return SPRITES.portraits[key];
  return '';
}

function getCharImages(charName) {
  if (!SPRITES || !SPRITES.characters) return [];
  const mapped = CHAR_SPRITE_ALIAS[charName] || charName;
  return SPRITES.characters[mapped] || [];
}

// === Condition label ===

function condLabel(cond) {
  return `${cond.var}${cond.op}${cond.val}`;
}

function condKey(conditions) {
  if (!conditions || conditions.length === 0) return '';
  return conditions.map(c => condLabel(c)).sort().join('|');
}

// === Narrative view rendering ===

function renderNarrative(passages) {
  const content = document.getElementById('content');
  content.innerHTML = '';
  const sections = groupByNarrative(passages);

  let totalPassages = 0;

  sections.forEach(section => {
    const allPassages = section.quests.reduce((a, q) => a.concat(q.passages), []);
    totalPassages += allPassages.length;

    // Section header (branch type)
    const secHeader = document.createElement('div');
    secHeader.className = 'chapter-header';
    const charName = section.id.startsWith('char_') ? section.id.slice(5) : '';
    const portrait = charName ? getCharPortrait(charName) : '';
    const portraitHtml = portrait
      ? `<img src="${portrait}" style="width:40px;height:40px;border-radius:50%;border:2px solid var(--accent);float:right;margin-left:8px" alt="${charName}" loading="lazy">`
      : '';
    secHeader.innerHTML = `
      ${portraitHtml}
      <h2>${section.label}</h2>
      <div class="chapter-stats">${section.quests.length} 支線 · ${allPassages.length} 段</div>
    `;

    const secBody = document.createElement('div');
    secBody.className = 'chapter-body';
    secBody.dataset.sectionId = section.id;

    secHeader.addEventListener('click', () => {
      const isOpen = secBody.classList.contains('open');
      if (isOpen) {
        secBody.classList.remove('open');
      } else {
        secBody.classList.add('open');
        if (!secBody.dataset.rendered) {
          renderSectionQuests(secBody, section.quests);
          secBody.dataset.rendered = '1';
        }
      }
    });

    content.appendChild(secHeader);
    content.appendChild(secBody);
  });

  document.getElementById('stats').innerHTML =
    `<b>${sections.length}</b> 分區 · <b>${totalPassages}</b> 段落`;
}

function renderSectionQuests(container, quests) {
  quests.forEach(quest => {
    const qHeader = document.createElement('div');
    qHeader.className = 'sub-group-header';
    const portrait = quest.characters.length > 0 ? getCharPortrait(quest.characters[0]) : '';
    const portraitHtml = portrait
      ? `<img src="${portrait}" class="scene-portrait" alt="${quest.characters[0]}" loading="lazy">`
      : '';
    const esLabel = quest.es_idx != null
      ? `[${String(quest.es_idx).padStart(3,'0')}] ${quest.es_name}`
      : quest.es_name;
    qHeader.innerHTML = `
      ${portraitHtml}
      <h4>${esLabel}</h4>
      <div class="meta">${quest.passages.length} 段</div>
    `;

    const qBody = document.createElement('div');
    qBody.className = 'sub-group-body';

    qHeader.addEventListener('click', () => {
      const isOpen = qBody.classList.contains('open');
      if (isOpen) {
        qBody.classList.remove('open');
      } else {
        qBody.classList.add('open');
        if (!qBody.dataset.rendered) {
          renderQuestPassages(qBody, quest.passages);
          qBody.dataset.rendered = '1';
        }
      }
    });

    container.appendChild(qHeader);
    container.appendChild(qBody);
  });
}

function renderQuestPassages(container, passages) {
  let html = '';
  let lastCondKey = null;

  passages.forEach(p => {
    const ck = condKey(p.conditions);

    // Condition separator when group changes
    if (ck !== lastCondKey) {
      if (ck) {
        html += `<div class="cond-separator">
          <div class="cond-group-label">${p.conditions.map(c =>
            `<span class="cond-tag">${condLabel(c)}</span>`).join(' ')}</div>
        </div>`;
      } else if (lastCondKey !== null) {
        html += '<div class="cond-separator"><div class="cond-group-label" style="color:var(--text2)">[無條件]</div></div>';
      }
      lastCondKey = ck;
    }

    const enPreview = showEnglish && p.text_en_preview
      ? `<div style="font-size:11px;color:var(--text2);margin-top:6px;font-style:italic">${p.text_en_preview}...</div>`
      : '';

    // 多角色頭像列
    const charPortraits = (p.characters && p.characters.length > 1)
      ? `<div class="passage-portraits">${
          p.characters.map(c => {
            const src = getCharPortrait(c);
            return src ? `<img src="${src}" alt="${c}" title="${c}" loading="lazy">` : '';
          }).filter(Boolean).join('')
        }</div>`
      : '';

    const spriteImg = (p.sprites && p.sprites.length > 0)
      ? `<img class="passage-img" src="${p.sprites[0].image}"
             alt="${p.sprites[0].obj} - ${p.sprites[0].anim}"
             loading="lazy"
             onclick="openLightbox(this.src)"
             onerror="this.style.display='none'">`
      : '';
    const wrapClass = spriteImg ? 'passage-with-img' : '';

    html += `<div class="passage">
      <span class="pid">pid=${p.pid}</span>
      ${charPortraits}
      <div class="${wrapClass}">
        ${spriteImg}
        <div class="passage-text-col">
          <div class="text">${p.text_zh}</div>
          ${enPreview}
        </div>
      </div>
    </div>`;
  });
  container.innerHTML = html;
}

// === Scene/Character view rendering ===

function renderSceneBatch(scenes, startIdx) {
  const content = document.getElementById('content');
  const end = Math.min(startIdx + BATCH_SIZE, scenes.length);

  for (let i = startIdx; i < end; i++) {
    const scene = scenes[i];

    // Scene header
    const header = document.createElement('div');
    header.className = 'scene-header';
    const headerLabel = currentView === 'character'
      ? scene.es_name
      : `[${String(scene.es_idx).padStart(3,'0')}] ${scene.es_name}`;
    const portrait = scene.characters.length > 0 ? getCharPortrait(scene.characters[0]) : '';
    const portraitHtml = portrait
      ? `<img src="${portrait}" class="scene-portrait" alt="${scene.characters[0]}" loading="lazy">`
      : '';
    header.innerHTML = `
      ${portraitHtml}
      <div class="scene-header-text">
        <h3>${headerLabel}</h3>
        <div class="meta">
          <span class="cat-tag">${scene.category}</span>
          ${scene.characters.map(c => `<span class="char-tag">${c}</span>`).join('')}
          — ${scene.passages.length} 段
        </div>
      </div>
    `;

    const passagesDiv = document.createElement('div');
    passagesDiv.className = 'scene-passages';
    passagesDiv.dataset.sceneIdx = i;

    header.addEventListener('click', () => {
      const isOpen = passagesDiv.classList.contains('open');
      if (isOpen) {
        passagesDiv.classList.remove('open');
      } else {
        passagesDiv.classList.add('open');
        if (!passagesDiv.dataset.rendered) {
          renderPassages(passagesDiv, scene.passages);
          passagesDiv.dataset.rendered = '1';
        }
      }
    });

    content.appendChild(header);
    content.appendChild(passagesDiv);
  }

  renderedScenes = end;
  updateStats(scenes);
}

function renderPassages(container, passages) {
  let html = '';
  passages.forEach(p => {
    const condHtml = p.conditions.length > 0
      ? `<div class="cond-tags">${p.conditions.map(c =>
          `<span class="cond-tag">${condLabel(c)}</span>`).join('')}</div>`
      : '';

    const enPreview = showEnglish && p.text_en_preview
      ? `<div style="font-size:11px;color:var(--text2);margin-top:6px;font-style:italic">${p.text_en_preview}...</div>`
      : '';

    // 多角色頭像列
    const charPortraits = (p.characters && p.characters.length > 1)
      ? `<div class="passage-portraits">${
          p.characters.map(c => {
            const src = getCharPortrait(c);
            return src ? `<img src="${src}" alt="${c}" title="${c}" loading="lazy">` : '';
          }).filter(Boolean).join('')
        }</div>`
      : '';

    const spriteImg = (p.sprites && p.sprites.length > 0)
      ? `<img class="passage-img" src="${p.sprites[0].image}"
             alt="${p.sprites[0].obj} - ${p.sprites[0].anim}"
             loading="lazy"
             onclick="openLightbox(this.src)"
             onerror="this.style.display='none'">`
      : '';
    const wrapClass = spriteImg ? 'passage-with-img' : '';

    html += `<div class="passage">
      <span class="pid">pid=${p.pid}</span>
      ${condHtml}
      ${charPortraits}
      <div class="${wrapClass}">
        ${spriteImg}
        <div class="passage-text-col">
          <div class="text">${p.text_zh}</div>
          ${enPreview}
        </div>
      </div>
    </div>`;
  });
  container.innerHTML = html;
}

// === Main render/filter logic ===

function resetAndRender() {
  const content = document.getElementById('content');
  content.innerHTML = '';
  renderedScenes = 0;

  const passages = getFilteredPassages();

  if (currentView === 'narrative') {
    renderNarrative(passages);
    return;
  }

  const scenes = currentView === 'character' ? groupByCharacter(passages) : groupByScene(passages);
  renderSceneBatch(scenes, 0);

  // Infinite scroll
  content._scenes = scenes;
  content._scrollHandler = () => {
    if (content.scrollTop + content.clientHeight >= content.scrollHeight - 200) {
      if (renderedScenes < scenes.length) {
        renderSceneBatch(scenes, renderedScenes);
      }
    }
  };
  content.addEventListener('scroll', content._scrollHandler);
}

function applyFilters() {
  resetAndRender();
}

function updateStats(scenes) {
  const total = scenes.reduce((s, sc) => s + sc.passages.length, 0);
  document.getElementById('stats').innerHTML =
    `<b>${scenes.length}</b> 場景 · <b>${total}</b> 段落`;
}

// === View switching ===

function setActiveView(view) {
  currentView = view;
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(
    view === 'narrative' ? 'viewNarrative' :
    view === 'scene' ? 'viewScene' : 'viewChar'
  ).classList.add('active');
  resetAndRender();
}

// === Init ===
function init() {
  buildCharFilter();

  // Search
  let searchTimeout;
  document.getElementById('searchBox').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchQuery = e.target.value.trim();
      resetAndRender();
    }, 300);
  });

  document.getElementById('showAllVariants').addEventListener('change', (e) => {
    showAllVariants = e.target.checked;
    applyFilters();
  });
  document.getElementById('showEnglish').addEventListener('change', (e) => {
    showEnglish = e.target.checked;
    document.querySelectorAll('.scene-passages.open, .sub-group-body.open').forEach(div => {
      div.dataset.rendered = '';
    });
    applyFilters();
  });

  // View mode buttons
  document.getElementById('viewNarrative').addEventListener('click', () => setActiveView('narrative'));
  document.getElementById('viewScene').addEventListener('click', () => setActiveView('scene'));
  document.getElementById('viewChar').addEventListener('click', () => setActiveView('character'));

  resetAndRender();
}

// Start
loadData();
</script>
</body>
</html>
