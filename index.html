<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>迷宮之下 — 互動敘事地圖</title>
<style>
:root {
  --bg: #1a1a2e;
  --bg2: #16213e;
  --bg3: #0f3460;
  --text: #e0e0e0;
  --text2: #a0a0b0;
  --accent: #e94560;
  --accent2: #533483;
  --border: #2a2a4a;
  --card: #1e1e3a;
  --tag-char: #4a9;
  --tag-cond: #a74;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  height: 100vh;
  overflow: hidden;
}
/* Layout */
.app { display: flex; height: 100vh; }
.sidebar {
  width: 300px;
  min-width: 280px;
  background: var(--bg2);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  padding: 16px;
  flex-shrink: 0;
}
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.toolbar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  scroll-behavior: smooth;
}

/* Sidebar */
.sidebar h2 {
  font-size: 14px;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin: 16px 0 8px 0;
  border-bottom: 1px solid var(--border);
  padding-bottom: 4px;
}
.sidebar h2:first-child { margin-top: 0; }
.control-group { margin-bottom: 8px; }
.control-group label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
  color: var(--text2);
  margin-bottom: 2px;
}
.control-group label span.val {
  color: var(--accent);
  font-weight: bold;
  font-size: 14px;
}
input[type="range"] {
  width: 100%;
  accent-color: var(--accent);
  cursor: pointer;
}
.toggle-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
  font-size: 13px;
  color: var(--text2);
  cursor: pointer;
}
.toggle-row input { accent-color: var(--accent); cursor: pointer; }
.toggle-row:hover { color: var(--text); }

/* Character filter */
.char-list { display: flex; flex-wrap: wrap; gap: 4px; margin: 4px 0; }
.char-btn {
  padding: 3px 8px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}
.char-btn:hover { border-color: var(--tag-char); color: var(--tag-char); }
.char-btn.active {
  background: var(--tag-char);
  color: #fff;
  border-color: var(--tag-char);
}

/* Toolbar */
.toolbar .stats {
  font-size: 13px;
  color: var(--text2);
}
.toolbar .stats b { color: var(--accent); }
.search-box {
  padding: 4px 10px;
  border-radius: 16px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text);
  font-size: 13px;
  width: 250px;
}
.search-box:focus { outline: none; border-color: var(--accent); }
.view-toggle {
  margin-left: auto;
  display: flex;
  gap: 4px;
}
.view-btn {
  padding: 4px 12px;
  border-radius: 4px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-size: 12px;
  cursor: pointer;
}
.view-btn.active { background: var(--accent2); color: #fff; border-color: var(--accent2); }

/* Content cards */
.scene-header {
  background: var(--bg3);
  padding: 12px 16px;
  margin: 16px 0 8px 0;
  border-radius: 8px;
  border-left: 4px solid var(--accent);
  cursor: pointer;
  user-select: none;
}
.scene-header h3 { font-size: 16px; margin-bottom: 2px; }
.scene-header .meta { font-size: 12px; color: var(--text2); }
.scene-header .char-tags { display: inline; }
.scene-header .char-tag {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 8px;
  background: var(--tag-char);
  color: #fff;
  font-size: 11px;
  margin-left: 4px;
}
.scene-header .cat-tag {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 8px;
  background: var(--accent2);
  color: #fff;
  font-size: 11px;
}

.passage {
  background: var(--card);
  padding: 12px 16px;
  margin: 4px 0;
  border-radius: 6px;
  border-left: 3px solid transparent;
  transition: border-color 0.2s;
}
.passage:hover { border-left-color: var(--accent); }
.passage .cond-tags {
  margin-bottom: 6px;
}
.passage .cond-tag {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 4px;
  background: rgba(170, 119, 68, 0.2);
  color: var(--tag-cond);
  font-size: 11px;
  margin-right: 4px;
  font-family: monospace;
}
.passage .pid {
  font-size: 11px;
  color: var(--text2);
  float: right;
}
.passage .text { font-size: 14px; line-height: 1.8; }
.passage.hidden-by-state {
  opacity: 0.25;
  border-left-color: transparent;
}
.passage.match-state { border-left-color: var(--tag-char); }

/* Loading */
.loading {
  text-align: center;
  padding: 60px;
  color: var(--text2);
  font-size: 18px;
}
.loading .spinner {
  display: inline-block;
  width: 40px; height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Virtual scroll sentinel */
.sentinel { height: 1px; }

/* Responsive */
@media (max-width: 768px) {
  .app { flex-direction: column; }
  .sidebar {
    width: 100%;
    max-height: 40vh;
    border-right: none;
    border-bottom: 1px solid var(--border);
  }
}

/* Title */
.app-title {
  font-size: 16px;
  font-weight: bold;
  color: var(--accent);
  margin-bottom: 8px;
  text-align: center;
}
.app-subtitle {
  font-size: 11px;
  color: var(--text2);
  text-align: center;
  margin-bottom: 12px;
}

/* Scene collapse */
.scene-passages { display: none; }
.scene-passages.open { display: block; }

/* Show all variants toggle */
.show-all-toggle {
  font-size: 12px;
  color: var(--accent);
  cursor: pointer;
  padding: 4px 0;
  text-align: center;
}
.show-all-toggle:hover { text-decoration: underline; }

/* Scrollbar */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent2); }
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar: State Controls -->
  <div class="sidebar" id="sidebar">
    <div class="app-title">迷宮之下</div>
    <div class="app-subtitle">Underneath the Labyrinth — 互動敘事地圖</div>

    <h2>角色篩選</h2>
    <div class="char-list" id="charFilter">
      <button class="char-btn active" data-char="all">全部</button>
    </div>

    <h2>玩家狀態</h2>
    <div id="stateControls"></div>

    <h2>顯示模式</h2>
    <div class="toggle-row">
      <input type="checkbox" id="filterMode" checked>
      <label for="filterMode">高亮匹配 / 隱藏不匹配</label>
    </div>
    <div class="toggle-row">
      <input type="checkbox" id="showAllVariants">
      <label for="showAllVariants">展開所有變體</label>
    </div>
    <div class="toggle-row">
      <input type="checkbox" id="showEnglish">
      <label for="showEnglish">顯示英文原文預覽</label>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="toolbar">
      <input type="text" class="search-box" id="searchBox" placeholder="搜尋文本 / 角色 / 場景...">
      <div class="stats" id="stats"></div>
      <div class="view-toggle">
        <button class="view-btn active" data-view="scene" id="viewScene">按場景</button>
        <button class="view-btn" data-view="character" id="viewChar">按角色</button>
      </div>
    </div>
    <div class="content" id="content">
      <div class="loading">
        <div class="spinner"></div>
        <div>載入敘事數據中...</div>
      </div>
    </div>
  </div>
</div>

<script>
// === Global State ===
let DATA = null;
let stateValues = {};
let activeChar = 'all';
let searchQuery = '';
let filterMode = true;
let showAllVariants = false;
let showEnglish = false;
let currentView = 'scene';
let renderedScenes = 0;
const BATCH_SIZE = 15;

// === Data Loading ===
async function loadData() {
  const resp = await fetch('data/passages.json');
  DATA = await resp.json();
  // Init state values from key_variables
  DATA.key_variables.forEach(v => {
    stateValues[v.id] = v.default;
  });
  init();
}

// === Condition Evaluation ===
function evalCondition(cond) {
  const varName = cond.var;
  const op = cond.op;
  let val = cond.val;
  const current = stateValues[varName];

  if (current === undefined) return true; // unknown var = pass
  if (val === null || val === undefined) return true;

  // Handle string values
  if (typeof val === 'string' && !isNaN(val)) val = Number(val);
  if (typeof current === 'string' && !isNaN(current)) {
    // skip non-numeric comparisons
  }

  const numCurrent = Number(current);
  const numVal = Number(val);

  if (isNaN(numCurrent) || isNaN(numVal)) {
    // String comparison
    if (op === '==' || op === '===') return String(current) === String(val);
    if (op === '!=') return String(current) !== String(val);
    return true;
  }

  switch (op) {
    case '==': return numCurrent === numVal;
    case '!=': return numCurrent !== numVal;
    case '<': return numCurrent < numVal;
    case '<=': return numCurrent <= numVal;
    case '>': return numCurrent > numVal;
    case '>=': return numCurrent >= numVal;
    default: return true;
  }
}

function evalPassageConditions(passage) {
  if (!passage.conditions || passage.conditions.length === 0) return true;
  return passage.conditions.every(c => evalCondition(c));
}

// === Rendering ===
function buildStateControls() {
  const container = document.getElementById('stateControls');
  let html = '';
  DATA.key_variables.forEach(v => {
    if (v.type === 'range') {
      html += `<div class="control-group">
        <label>${v.label} <span class="val" id="val_${v.id}">${v.default}</span></label>
        <input type="range" min="${v.min}" max="${v.max}" value="${v.default}"
               data-var="${v.id}" class="state-slider">
      </div>`;
    } else if (v.type === 'toggle') {
      html += `<div class="toggle-row">
        <input type="checkbox" data-var="${v.id}" class="state-toggle" id="tog_${v.id}">
        <label for="tog_${v.id}">${v.label}</label>
      </div>`;
    }
  });
  container.innerHTML = html;

  // Bind events
  container.querySelectorAll('.state-slider').forEach(el => {
    el.addEventListener('input', (e) => {
      const varName = e.target.dataset.var;
      const val = Number(e.target.value);
      stateValues[varName] = val;
      document.getElementById(`val_${varName}`).textContent = val;
      applyFilters();
    });
  });
  container.querySelectorAll('.state-toggle').forEach(el => {
    el.addEventListener('change', (e) => {
      stateValues[e.target.dataset.var] = e.target.checked ? 1 : 0;
      applyFilters();
    });
  });
}

function buildCharFilter() {
  const container = document.getElementById('charFilter');
  let html = '<button class="char-btn active" data-char="all">全部</button>';
  DATA.characters.forEach(ch => {
    const count = DATA.passages.filter(p => p.characters.includes(ch)).length;
    html += `<button class="char-btn" data-char="${ch}">${ch} (${count})</button>`;
  });
  container.innerHTML = html;
  container.querySelectorAll('.char-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      container.querySelectorAll('.char-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      activeChar = e.target.dataset.char;
      resetAndRender();
    });
  });
}

function getFilteredPassages() {
  let passages = DATA.passages;
  // Character filter
  if (activeChar !== 'all') {
    passages = passages.filter(p => p.characters.includes(activeChar));
  }
  // Search
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    passages = passages.filter(p =>
      (p.text_zh || '').toLowerCase().includes(q) ||
      (p.es_name || '').toLowerCase().includes(q) ||
      p.characters.some(c => c.toLowerCase().includes(q))
    );
  }
  return passages;
}

function groupByScene(passages) {
  const groups = new Map();
  passages.forEach(p => {
    const key = p.es_idx;
    if (!groups.has(key)) {
      groups.set(key, {
        es_idx: p.es_idx,
        es_name: p.es_name,
        characters: [],
        category: p.category,
        passages: [],
      });
    }
    const group = groups.get(key);
    group.passages.push(p);
    p.characters.forEach(ch => {
      if (!group.characters.includes(ch)) group.characters.push(ch);
    });
  });
  return Array.from(groups.values());
}

function groupByCharacter(passages) {
  const groups = new Map();
  // Passages with characters
  passages.forEach(p => {
    const chars = p.characters.length > 0 ? p.characters : ['_untagged'];
    chars.forEach(ch => {
      if (!groups.has(ch)) {
        groups.set(ch, {
          es_idx: 0,
          es_name: ch === '_untagged' ? '未標記角色' : ch,
          characters: ch === '_untagged' ? [] : [ch],
          category: 'Character',
          passages: [],
        });
      }
      groups.get(ch).passages.push(p);
    });
  });
  // Sort: named characters first (alphabetical), _untagged last
  const sorted = Array.from(groups.values()).sort((a, b) => {
    if (a.es_name === '未標記角色') return 1;
    if (b.es_name === '未標記角色') return -1;
    return a.es_name.localeCompare(b.es_name);
  });
  return sorted;
}

function condLabel(cond) {
  return `${cond.var}${cond.op}${cond.val}`;
}

function renderSceneBatch(scenes, startIdx) {
  const content = document.getElementById('content');
  const end = Math.min(startIdx + BATCH_SIZE, scenes.length);

  for (let i = startIdx; i < end; i++) {
    const scene = scenes[i];
    const matchCount = scene.passages.filter(p => evalPassageConditions(p)).length;

    // Scene header
    const header = document.createElement('div');
    header.className = 'scene-header';
    const headerLabel = currentView === 'character'
      ? scene.es_name
      : `[${String(scene.es_idx).padStart(3,'0')}] ${scene.es_name}`;
    header.innerHTML = `
      <h3>${headerLabel}</h3>
      <div class="meta">
        <span class="cat-tag">${scene.category}</span>
        ${scene.characters.map(c => `<span class="char-tag">${c}</span>`).join('')}
        — ${scene.passages.length} 段 · <b>${matchCount}</b> 段匹配當前狀態
      </div>
    `;

    const passagesDiv = document.createElement('div');
    passagesDiv.className = 'scene-passages';
    passagesDiv.dataset.sceneIdx = i;

    header.addEventListener('click', () => {
      const isOpen = passagesDiv.classList.contains('open');
      if (isOpen) {
        passagesDiv.classList.remove('open');
      } else {
        passagesDiv.classList.add('open');
        if (!passagesDiv.dataset.rendered) {
          renderPassages(passagesDiv, scene.passages);
          passagesDiv.dataset.rendered = '1';
        }
      }
    });

    content.appendChild(header);
    content.appendChild(passagesDiv);
  }

  renderedScenes = end;
  updateStats(scenes);
}

function renderPassages(container, passages) {
  let html = '';
  passages.forEach(p => {
    const matches = evalPassageConditions(p);
    const condHtml = p.conditions.length > 0
      ? `<div class="cond-tags">${p.conditions.map(c =>
          `<span class="cond-tag">${condLabel(c)}</span>`).join('')}</div>`
      : '';

    const cls = matches ? 'passage match-state' :
                (filterMode ? 'passage hidden-by-state' : 'passage');

    const enPreview = showEnglish && p.text_en_preview
      ? `<div style="font-size:11px;color:var(--text2);margin-top:6px;font-style:italic">${p.text_en_preview}...</div>`
      : '';

    html += `<div class="${cls}">
      <span class="pid">pid=${p.pid}</span>
      ${condHtml}
      <div class="text">${p.text_zh}</div>
      ${enPreview}
    </div>`;
  });
  container.innerHTML = html;
}

function resetAndRender() {
  const content = document.getElementById('content');
  content.innerHTML = '';
  renderedScenes = 0;

  const passages = getFilteredPassages();
  const scenes = currentView === 'character' ? groupByCharacter(passages) : groupByScene(passages);
  renderSceneBatch(scenes, 0);

  // Infinite scroll
  content._scenes = scenes;
  content._scrollHandler = () => {
    if (content.scrollTop + content.clientHeight >= content.scrollHeight - 200) {
      if (renderedScenes < scenes.length) {
        renderSceneBatch(scenes, renderedScenes);
      }
    }
  };
  content.addEventListener('scroll', content._scrollHandler);
}

function applyFilters() {
  // Re-evaluate all rendered passages
  document.querySelectorAll('.scene-passages.open').forEach(div => {
    const sceneIdx = Number(div.dataset.sceneIdx);
    const scenes = document.getElementById('content')._scenes;
    if (scenes && scenes[sceneIdx]) {
      renderPassages(div, scenes[sceneIdx].passages);
      // Update header match count
      const header = div.previousElementSibling;
      const matchCount = scenes[sceneIdx].passages.filter(p => evalPassageConditions(p)).length;
      const meta = header.querySelector('.meta');
      const parts = meta.innerHTML.split('·');
      if (parts.length > 1) {
        parts[1] = ` <b>${matchCount}</b> 段匹配當前狀態`;
        meta.innerHTML = parts.join('·');
      }
    }
  });
}

function updateStats(scenes) {
  const total = scenes.reduce((s, sc) => s + sc.passages.length, 0);
  const matched = scenes.reduce((s, sc) =>
    s + sc.passages.filter(p => evalPassageConditions(p)).length, 0);
  document.getElementById('stats').innerHTML =
    `<b>${scenes.length}</b> 場景 · <b>${total}</b> 段落 · <b>${matched}</b> 匹配`;
}

// === Init ===
function init() {
  buildStateControls();
  buildCharFilter();

  // Search
  let searchTimeout;
  document.getElementById('searchBox').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchQuery = e.target.value.trim();
      resetAndRender();
    }, 300);
  });

  // Filter mode toggle
  document.getElementById('filterMode').addEventListener('change', (e) => {
    filterMode = e.target.checked;
    applyFilters();
  });
  document.getElementById('showAllVariants').addEventListener('change', (e) => {
    showAllVariants = e.target.checked;
    applyFilters();
  });
  document.getElementById('showEnglish').addEventListener('change', (e) => {
    showEnglish = e.target.checked;
    // Re-render open passages
    document.querySelectorAll('.scene-passages.open').forEach(div => {
      div.dataset.rendered = '';
    });
    applyFilters();
  });

  // View mode buttons
  document.getElementById('viewScene').addEventListener('click', () => {
    currentView = 'scene';
    document.getElementById('viewScene').classList.add('active');
    document.getElementById('viewChar').classList.remove('active');
    resetAndRender();
  });
  document.getElementById('viewChar').addEventListener('click', () => {
    currentView = 'character';
    document.getElementById('viewChar').classList.add('active');
    document.getElementById('viewScene').classList.remove('active');
    resetAndRender();
  });

  resetAndRender();
}

// Start
loadData();
</script>
</body>
</html>
